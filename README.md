# 情報I 学習サイト（GAS版）

Google Apps Script + Google スプレッドシートで動く学習用 Web アプリです。  
単元・テスト範囲を選んで問題を解き、解答ログ・ユーザごとの正答率・問題ごとの出題重みをスプレッドシートで管理します。

> ※ このリポジトリには実際のスプレッドシートURLやデプロイURLは含めていません。
> 　実運用時は `Code.gs` 内の `SPREADSHEET_URL` を自分の環境に合わせて書き換えてください。

---

## Code.gs

GAS 側のメインロジック。スプレッドシートとのやりとり・出題ロジック・採点処理をまとめています。

### 主な役割

- スプレッドシートの読み書き
  - `openSheet_()`：シート名から対象シートを開く（なければ作成）
- 問題取得
  - `getQuestions()`：  
    「問題DB」シートから問題一覧を読み込み、  
    単元（unit）・テスト範囲（range）によるフィルタをかけて返す
  - `getUnitOptions()` / `getRangeOptions()`：  
    単元・テスト範囲のユニークな一覧を取得（home画面のチップ表示用）
- ユーザ集計
  - `getUserStats(email)`：  
    「ユーザ集計」シートから、そのユーザの累計解答数と正解数を取得
  - `updateUserStats(email, isCorrect)`：  
    解答のたびに累計と正解数を更新
- ユーザごとの出題重み
  - 「ユーザ重み」シートで「ユーザ × 問題ID」のマトリクスを管理
  - `pickWeightedQuestion(email, questions)`：  
    デフォルト重み 10、正解で -1、誤答で +5（1〜100の範囲）というルールで、  
    重み付きランダムに次の問題を選ぶ
  - `updateUserWeight(email, questionId, isCorrect)`：  
    解答結果に応じて、そのユーザにとっての問題の重みを更新
- 解答ログ
  - `logAnswer(email, question, isCorrect, userAnswer)`：  
    「解答ログ」シートに 1 行ずつ記録
- Web アプリ入口
  - `doGet(e)`：
    - `page=quiz`：`quiz.html` を描画（最初の1問もここで選択）
    - それ以外：`home.html` を描画（単元・範囲選択画面）
- 採点API
  - `checkAnswer(...)`：  
    `google.script.run` から呼ばれる。  
    問題IDから問題を引き直し、回答の正誤判定・ログ記録・  
    ユーザ集計更新・重み更新・次の問題選択までを行い、結果を JSON で返す。

---

## home.html

ホーム画面（問題範囲の選択画面）用のテンプレートです。

### 主な役割

- ログイン中のユーザ情報の表示
  - メールアドレス（取得できる場合のみ）
  - 累計解答数・正解数・正答率の表示
- 出題範囲の選択 UI
  - 単元（unit）・テスト範囲（range）を「チップ」形式で表示
  - クリック／タップで複数選択可能
  - 何も選ばない場合は「全範囲から出題」という扱い
- クイズ画面への遷移
  - `<form>` に `unitFilters` / `rangeFilters` をカンマ区切りで格納して `GET` 送信
  - `page=quiz` を付けて、同じ Web アプリの `quiz` ページを開く
- 細かいUI
  - スマホ〜PCで見やすいように `rem` ベースのフォントサイズを調整
  - `window.innerWidth / innerHeight` を表示するデバッグ用表示（viewport情報）

---

## quiz.html

問題を解いていく画面用のテンプレートです。  
`doGet()` から渡された `question` オブジェクトをもとに、JS側でUIを切り替えています。

### 主な役割

- 上部バー
  - タイトル表示
  - 「🏠 ホーム画面に戻る」ボタン（`webAppUrl` を使って同じWebアプリのトップに戻る）
  （本来は `webAppUrl` を使って同じ Web アプリのトップに戻す想定だが、環境によってうまく動かないケースがあったため、**実際の運用ではデプロイURLを直貼りしたほうが安定するかもしれない**）
- ユーザ情報表示
  - メールアドレス
  - 累計解答数・正解数・正答率（`checkAnswer` のレスポンスで随時更新）
- 問題文・形式の表示
  - 問題ID
  - 問題形式（`多肢選択` / `正誤問題` / `記述問題`）
  - 問題文

### 問題形式ごとの UI

- 多肢選択問題
  - 選択肢1〜4をボタンで表示
  - ラベル「ア / イ / ウ / エ」を自動付与
  - クリックしたラベルを `userAnswer` として `checkAnswer` に送信
- 正誤問題
  - 「◯ 正しい」「× 誤っている」の2ボタン
  - 内部的には `o` / `x` を `userAnswer` として送信
- 記述問題
  - テキストボックス＋「解答する」ボタン
  - 入力文字列をそのまま `userAnswer` として送信

### 採点結果の表示

- 正誤メッセージ
  - 正解：`正解です！`
  - 不正解：`不正解です…`
- 正解表示
  - 多肢選択：正しいラベル（ア〜エ）または正答そのもの
  - 正誤・記述：正答そのものを表示
- 解説表示
  - 多肢選択：  
    「解説1〜4」を `ア〜エ` に対応させて表示  
    空の解説は自動的に非表示
  - 正誤・記述：
    「解説1」のみを単一の解説として表示（ア〜エラベルは使わない）
- 「次の問題へ」ボタン
  - `checkAnswer` のレスポンスに含まれる `nextQuestion` を使って、  
    画面を書き換え（ページ遷移なしで次の問題を出す）

---

## スプレッドシート構成

このアプリは、1つのスプレッドシート内で下記4シートを使います。

### 1. 問題DB（SHEET_QUESTION_DB = '問題DB'）

問題本体を管理するシートです。

| 列 | 内容             | 備考 |
|----|------------------|------|
| A  | 問題ID           | 数字 or 文字列。ユニークになるように付ける |
| B  | 問題形式         | `"多肢選択"` / `"正誤問題"` / `"記述問題"` |
| C  | 問題文           | 表示する問題テキスト |
| D  | 選択肢1          | 多肢選択で使用。未使用なら空でも可 |
| E  | 選択肢2          | 同上 |
| F  | 選択肢3          | 同上 |
| G  | 選択肢4          | 同上 |
| H  | 正答             | 多肢選択：選択肢の中身と完全一致する文字列<br>正誤問題：`o` or `x`（大文字小文字は問わない）<br>記述問題：正解の文字列（完全一致判定） |
| I  | 解説1            | 多肢選択：アの解説 / 正誤・記述：単一解説として使用 |
| J  | 解説2            | 多肢選択：イの解説 |
| K  | 解説3            | 多肢選択：ウの解説 |
| L  | 解説4            | 多肢選択：エの解説 |
| M  | 単元             | 出題範囲フィルタ用。home画面の「単元チップ」に反映 |
| N  | テスト範囲       | 出題範囲フィルタ用。home画面の「テスト範囲チップ」に反映 |

---

### 2. 解答ログ（SHEET_LOG = '解答ログ'）

一人ひとりの解答履歴を保存するシートです。  
1 解答につき 1 行追記されます。

| 列 | 内容           |
|----|----------------|
| A  | タイムスタンプ |
| B  | ユーザ（メールアドレス） |
| C  | 問題ID         |
| D  | 問題形式       |
| E  | 正誤（`○` or `×`） |
| F  | ユーザ回答（ア/イ/ウ/エ, o/x, 文字列など） |
| G  | 正答           |
| H  | 単元           |
| I  | テスト範囲     |

---

### 3. ユーザ集計（SHEET_USER_STATS = 'ユーザ集計'）

ユーザごとの累計解答数と正解数を管理するシートです。

| 列 | 内容         |
|----|--------------|
| A  | ユーザ（メールアドレス） |
| B  | 累計解答数   |
| C  | 正解累計     |

`checkAnswer()` を呼ぶたびに `updateUserStats()` が自動更新します。  
quiz画面の「累計解答数 / 正解数 / 正答率」の表示に使われます。

---

### 4. ユーザ重み（SHEET_USER_WEIGHTS = 'ユーザ重み'）

「ユーザ × 問題ID」の出題重みを管理するシートです。  
使い始めると、自動的に列・行が増えます。

| 列 / 行 | 内容 |
|---------|------|
| 1行目   | A1: `"ユーザ"`、B1以降: 問題ID（`問題DB` の A列の値）が並ぶ |
| 2行目以降 | A列: ユーザ（メールアドレス）、B列以降: そのユーザに対する各問題の重み（1〜100の整数） |

- 初期値は 10
- 正解すると `max(weight - 1, 1)`
- 誤答すると `min(weight + 5, 100)`
- `pickWeightedQuestion()` がこの重みを使ってランダムに次の問題を選ぶ

---

## セットアップ手順（簡易）

1. このリポジトリをクローン or ダウンロード
2. Google スプレッドシートで上記4シートを作成し、カラム構成を準備
3. Apps Script プロジェクトを作り、このリポジトリの `Code.gs`, `home.html`, `quiz.html` を貼り付け
4. `SPREADSHEET_URL` に自分のスプレッドシートURLを設定
5. Webアプリとしてデプロイ（「今すぐデプロイ」→「ウェブアプリ」）

